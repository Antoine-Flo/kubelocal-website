#!/usr/bin/env bash

set -euo pipefail

# Configuration
readonly REPO_OWNER="Antoine-Flo"
readonly REPO_NAME="kubelocal"
readonly GITHUB_API_URL="https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/releases/latest"
readonly TEMP_DIR="/tmp/kubelocal-install"

# Cleanup function
cleanup() {
    rm -rf "$TEMP_DIR" 2>/dev/null || true
}

# Trap to ensure cleanup on exit
trap cleanup EXIT

# Detect platform
detect_platform() {
    local os=""
    local arch=""
    
    echo "ðŸ” DÃ©tection de la plateforme..." >&2
    
    case "$(uname -s)" in
        Linux*)     os="linux" ;;
        *)          echo "âŒ Platforme non supportÃ©e: $(uname -s). Seul Linux AMD64 est supportÃ© pour l'instant." >&2; exit 1 ;;
    esac
    
    case "$(uname -m)" in
        x86_64|amd64)  arch="amd64" ;;
        *)             echo "âŒ Architecture non supportÃ©e: $(uname -m). Seul AMD64 est supportÃ© pour l'instant." >&2; exit 1 ;;
    esac
    
    local platform="${os}-${arch}"
    echo "âœ… Plateforme dÃ©tectÃ©e: $platform" >&2
    echo "$platform"
}

# Get latest release and download URL
get_download_url() {
    local platform="$1"
    local api_response
    
    echo "ðŸ” RÃ©cupÃ©ration des informations de la derniÃ¨re version..." >&2
    api_response=$(curl -s "$GITHUB_API_URL") || {
        echo "âŒ Erreur: Impossible de rÃ©cupÃ©rer les informations de version depuis GitHub API" >&2
        exit 1
    }
    
    local download_url
    download_url=$(echo "$api_response" | grep -o "\"browser_download_url\": \"[^\"]*${platform}[^\"]*\.tar\.gz\"" | cut -d'"' -f4)
    
    if [ -z "$download_url" ]; then
        echo "âŒ Erreur: Aucune version trouvÃ©e pour la plateforme $platform" >&2
        echo "ðŸ“‹ RÃ©ponse API reÃ§ue:" >&2
        echo "$api_response" | head -20 >&2
        exit 1
    fi
    
    echo "âœ… URL de tÃ©lÃ©chargement trouvÃ©e: $download_url" >&2
    echo "$download_url"
}

# Download and execute binary
download_and_execute() {
    local download_url="$1"
    local platform="$2"
    
    echo "ðŸ“ CrÃ©ation du rÃ©pertoire temporaire: $TEMP_DIR" >&2
    mkdir -p "$TEMP_DIR" || {
        echo "âŒ Erreur: Impossible de crÃ©er le rÃ©pertoire temporaire $TEMP_DIR" >&2
        exit 1
    }
    
    cd "$TEMP_DIR" || {
        echo "âŒ Erreur: Impossible d'accÃ©der au rÃ©pertoire temporaire $TEMP_DIR" >&2
        exit 1
    }
    
    local filename="kubelocal-${platform}.tar.gz"
    echo "â¬‡ï¸  TÃ©lÃ©chargement de $filename..." >&2
    curl -fsSL -o "$filename" "$download_url" || {
        echo "âŒ Erreur: Ã‰chec du tÃ©lÃ©chargement de $download_url" >&2
        exit 1
    }
    
    echo "ðŸ“¦ Extraction de l'archive..." >&2
    tar -xzf "$filename" >/dev/null 2>&1 || {
        echo "âŒ Erreur: Ã‰chec de l'extraction de l'archive $filename" >&2
        echo "ðŸ“‹ Contenu du rÃ©pertoire temporaire:" >&2
        ls -la . >&2
        exit 1
    }
    
    echo "ðŸ” Recherche du binaire kubelocal..." >&2
    local binary_path
    binary_path=$(find . -name "kubelocal" -type f | head -n1)
    
    if [ -z "$binary_path" ]; then
        echo "âŒ Erreur: Binaire kubelocal non trouvÃ© dans l'archive" >&2
        echo "ðŸ“‹ Contenu du rÃ©pertoire temporaire:" >&2
        ls -la . >&2
        echo "ðŸ“‹ Recherche de tous les fichiers:" >&2
        find . -type f >&2
        exit 1
    fi
    
    echo "âœ… Binaire trouvÃ©: $binary_path" >&2
    echo "ðŸ”§ Attribution des permissions d'exÃ©cution..." >&2
    chmod +x "$binary_path" || {
        echo "âŒ Erreur: Impossible d'attribuer les permissions d'exÃ©cution Ã  $binary_path" >&2
        exit 1
    }
    
    echo "ðŸš€ Lancement de kubelocal..." >&2
    # Rediriger stdin vers le terminal pour permettre les interactions
    "$binary_path" "$@" < /dev/tty
}

# Main
echo "ðŸš€ Installation de kubelocal..." >&2
echo "=================================" >&2

platform=$(detect_platform)
download_url=$(get_download_url "$platform")
download_and_execute "$download_url" "$platform" "$@"
