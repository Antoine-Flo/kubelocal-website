#!/usr/bin/env bash

set -euo pipefail

# Configuration
readonly REPO_OWNER="Antoine-Flo"
readonly REPO_NAME="kubelocal"
readonly GITHUB_API_URL="https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/releases/latest"
readonly TEMP_DIR="/tmp/kubelocal-install"

# Logging function
log() {
    echo "ðŸš€ kubelocal: $*" >&2
}

# Cleanup function
cleanup() {
    rm -rf "$TEMP_DIR" 2>/dev/null || true
}

# Trap to ensure cleanup on exit
trap cleanup EXIT

# Detect platform
detect_platform() {
    log "DÃ©tection de la plateforme..."
    local os=""
    local arch=""
    
    case "$(uname -s)" in
        Linux*)     os="linux" ;;
        *)          echo "Platforme non supportÃ©e: $(uname -s). Seul Linux AMD64 est supportÃ© pour l'instant." >&2; exit 1 ;;
    esac
    
    case "$(uname -m)" in
        x86_64|amd64)  arch="amd64" ;;
        *)             echo "Architecture non supportÃ©e: $(uname -m). Seul AMD64 est supportÃ© pour l'instant." >&2; exit 1 ;;
    esac
    
    local platform="${os}-${arch}"
    log "Plateforme dÃ©tectÃ©e: $platform"
    echo "$platform"
}

# Get latest release and download URL
get_download_url() {
    local platform="$1"
    local api_response
    
    log "RÃ©cupÃ©ration de la derniÃ¨re version depuis GitHub..."
    api_response=$(curl -s "$GITHUB_API_URL") || exit 1
    local download_url
    download_url=$(echo "$api_response" | grep -o "\"browser_download_url\": \"[^\"]*${platform}[^\"]*\.tar\.gz\"" | cut -d'"' -f4)
    log "URL de tÃ©lÃ©chargement: $download_url"
    echo "$download_url"
}

# Download and execute binary
download_and_execute() {
    local download_url="$1"
    local platform="$2"
    
    log "TÃ©lÃ©chargement du binaire kubelocal..."
    mkdir -p "$TEMP_DIR"
    cd "$TEMP_DIR"
    
    local filename="kubelocal-${platform}.tar.gz"
    curl -fsSL -o "$filename" "$download_url" || exit 1
    log "Extraction de l'archive..."
    tar -xzf "$filename" >/dev/null 2>&1 || exit 1
    
    local binary_path
    binary_path=$(find . -name "kubelocal" -type f | head -n1) || exit 1
    chmod +x "$binary_path"
    
    log "ExÃ©cution de kubelocal..."
    "$binary_path" "$@"
}

# Main
log "ðŸš€ Kubernetes Local Environment Installer"
log "DÃ©marrage de l'installation..."

platform=$(detect_platform)
download_url=$(get_download_url "$platform")
download_and_execute "$download_url" "$platform" "$@"
